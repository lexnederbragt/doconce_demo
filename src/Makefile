WHAT   := text1 reference1 exercise1 slide1 include1
# currently, choosing all do_files/*.do.txt, which is not optimal
DO_FILES   := $(shell ls do_files/*.do.txt)
DO_IN      := $(addsuffix .do.txt, ${WHAT})
EXTENSIONS := .html .pdf .ipynb .md
COMMANDS   := $(addsuffix .compile.sh, ${WHAT})
# common targets
TARGETS    := $(addsuffix .html, ${WHAT})
TARGETS    += $(addsuffix .pdf, ${WHAT})
TARGETS    += $(addsuffix .ipynb, ${WHAT})
TARGETS    += $(addsuffix .md, ${WHAT})
TARGETS    := $(addprefix ../pub/, ${TARGETS})

# targets specific for slides
TARGETS_SLIDE += $(addsuffix .deck.html, slide1)
TARGETS_SLIDE += $(addsuffix .reveal.html, slide1)
TARGETS_SLIDE += $(addsuffix .deck.pdf, slide1)
TARGETS_SLIDE += $(addsuffix .reveal.pdf, slide1)
TARGETS_SLIDE := $(addprefix ../pub/, ${TARGETS_SLIDE})

.PHONY : all test clean cleanall

all : ${DO_IN} ${TARGETS} ${COMMANDS} ${TARGETS_SLIDE}

test:
	@echo DO_FILES: ${DO_FILES}
	@echo DO_IN: ${DO_IN}
	@echo COMMANDS: ${COMMANDS}
	@echo TARGETS: ${TARGETS}
	@echo TARGETS_SLIDE: ${TARGETS_SLIDE}

# does this work?
text1:
	$(filter text1, ${TARGETS})

# does this work?
reference1:
	echo $(filter reference1, ${TARGETS})


# Building up the doconce file by adding successive doconce files
# grep do_files ../scripts/text1.prepare.sh | cut -c 5-
# $shell(grep do_files ../scripts/text1.prepare.sh | cut -c 5-)
%.do.txt : ../scripts/%.prepare.sh ${DO_FILES}
	# Target: $@
	source $< > $@

# commands used
# use the '--what-if' option to show
# what would happen if do files was updated
# use $(filter ../pub/$*%, ${TARGETS}) to select appropriate targets only
%.compile.sh : %.do.txt ${TARGETS}
	# Target: $@
	@echo "# This file is generated by make, do not edit" > $@
	@echo >> $@
	make -n --what-if $*.do.txt $(filter ../pub/$*%, ${TARGETS}) $(filter ../pub/$*%, ${TARGETS_SLIDE}) | ../scripts/format_commands.sh  >> $@

# html
../pub/%.html : %.do.txt
	# Building html
	# Target: $@
	doconce format html $< --execute && \
	mv $*.html $@

# pdf
../pub/%.pdf : %.do.txt
	# Building pdf
	# Target: $@
	doconce format pdflatex $< --latex_code_style=vrb --execute && \
	pdflatex $*.tex && \
	mv $*.pdf $@

# jupyter notebook for exercises with and without answers and solutions
# remove ipynb-*-src.tar.gz file afterwards
../pub/exercise%.ipynb : exercise%.do.txt
	# Building jupyter notebook for exercises with answers and solutions
	# Target: $@
	doconce format ipynb $< --execute && \
	mv exercise$*.ipynb ../pub/exercise$*-solutions.ipynb
	# Building jupyter notebook for exercises without answers and solutions
	doconce format ipynb $< --execute --without_solutions --without_answers && \
	mv exercise$*.ipynb $@

# all other jupyter notebooks
../pub/%.ipynb : %.do.txt
	# Building jupyter notebook
	# Target: $@
	doconce format ipynb $< --execute && \
	mv $*.ipynb $@

# markdown
../pub/%.md : %.do.txt
	# Building markdown
	# Target: $@
	doconce format markdown $< && \
	mv $*.md $@

# Start of slide specific commands
ifneq (,$(findstring slide,${WHAT}))

# reveal.js slides
../pub/slide%.reveal.html : slide%.do.txt
	# Building reveal.js slides
	# Target: $@
	doconce format html $< --html_output=slide$*.reveal --pygments_html_style=perldoc \
	    --keep_pygments_html_bg SLIDE_TYPE=reveal SLIDE_THEME=beige \
		--skip_inline_comments --execute \
	&& doconce slides_html slide$*.reveal reveal --html_slide_theme=beige && \
	mv slide$*.reveal.html $@ && \
	rsync -a reveal.js ../pub/ && rm -r reveal.js


# reveal.js PDF
../pub/%.reveal.pdf : ../pub/%.reveal.html
	# Building PDF of reveal.js slides
	# Target: $@
	deck2pdf --profile=revealjs $< $@

# deck.js slides
../pub/slide%.deck.html : slide%.do.txt
	# Building deck.js slides
	# Target: $@
	doconce format html $< --html_output=slide$*.deck --pygments_html_style=autumn \
	--keep_pygments_html_bg SLIDE_TYPE=reveal SLIDE_THEME=swiss \
	--skip_inline_comments --execute \
	&& doconce slides_html slide$*.deck deck --html_slide_theme=swiss && \
	mv slide$*.deck.html $@ && \
	rsync -a deck.js-latest ../pub/ && rm -r deck.js-latest

# deck.js PDF
../pub/%.deck.pdf : ../pub/%.deck.html
	# Building PDF of deck.js slides
	# Target: $@
	deck2pdf  --profile=deckjs $< $@
# End of slide specific commands
endif


# remove targets
clean :
	-rm ${TARGETS}
# Start of slide specific commands
ifneq (,$(findstring slide,${WHAT}))
	-rm ${TARGETS_SLIDE}
# End of slide specific commands
endif

# remove targets, .compile.sh .do.txt files and files doconce can recreate
# use with care
cleanall :
	doconce clean
	-rm ${DO_IN} ${COMMANDS} ${TARGETS} ${TARGETS_SLIDE}
