BASENAME   := text1
DO_FILES   := $(shell grep -o do_files\/.*do.txt ../scripts/${BASENAME}.prepare.sh)
DO_IN      := $(addsuffix .do.txt, ${BASENAME})
EXTENSIONS := .html .pdf .ipynb .md
COMMANDS   := $(addsuffix .compile.sh, ${BASENAME})
TARGETS    := $(addprefix ../pub/${BASENAME}, ${EXTENSIONS} )

.PHONY : all test clean cleanall

all : ${DO_IN} ${TARGETS} ${COMMANDS}

test:
	@echo DO_FILES: ${DO_FILES}
	@echo DO_IN: ${DO_IN}
	@echo COMMANDS: ${COMMANDS}
	@echo TARGETS: ${TARGETS}

# Building up the doconce file by adding successive doconce files
text1.do.txt : ../scripts/text1.prepare.sh ${DO_FILES}
	source $< > $@

# commands used
# use the '--what-if' option to show
# what would happen if do files was updated
%.compile.sh : %.do.txt ${TARGETS}
	@echo "# This file is generated by make, do not edit" > $@
	@echo >> $@
	make -n --what-if ${DO_IN} ${TARGETS} | ../scripts/format_commands.sh  >> $@

# html
../pub/%.html : %.do.txt
	# Building html
	doconce format html $< --execute && \
	mv $*.html $@

# pdf
../pub/%.pdf : %.do.txt
	# Building pdf
	doconce format pdflatex $< --latex_code_style=vrb --execute && \
	pdflatex $*.tex && \
	mv $*.pdf $@

# jupyter notebook for exercises with and without answers and solutions
../pub/exercise%.ipynb : exercise%.do.txt
	# Building jupyter notebook for exercises with answers and solutions
	doconce format ipynb $< --execute && \
	mv $*.ipynb ../pub/exercise$*-solutions.ipynb
	# Building jupyter notebook for exercises without answers and solutions
	doconce format ipynb $< --execute --without_solutions --without_answers && \
	mv $*.ipynb $@

# all other jupyter notebooks
../pub/%.ipynb : %.do.txt
	# Building jupyter notebook
	doconce format ipynb $< --execute && \
	mv $*.ipynb $@

# markdown
../pub/%.md : %.do.txt
	# Building markdown
	doconce format markdown $< && \
	mv $*.md $@

# reveal.js slides
../pub/%.reveal.html : %.do.txt
	# Building reveal.js slides
	doconce format html $< --html_output=$*.reveal --pygments_html_style=perldoc \
	    --keep_pygments_html_bg SLIDE_TYPE=reveal SLIDE_THEME=beige \
		--skip_inline_comments --execute \
	&& doconce slides_html $*.reveal reveal --html_slide_theme=beige && \
	mv $*.reveal.html $@


# reveal.js PDF
../pub/%.reveal.pdf : %.reveal.html
	# Building PDF of reveal.js slides
	deck2pdf --profile=revealjs $< $@ && \
	mv $*.reveal.pdf $@

# deck.js slides
../pub/%.deck.html : %.do.txt
	# Building deck.js slides
	doconce format html $< --html_output=$*.deck --pygments_html_style=autumn \
	--keep_pygments_html_bg SLIDE_TYPE=reveal SLIDE_THEME=swiss \
	--skip_inline_comments --execute \
	&& doconce slides_html $*.deck deck --html_slide_theme=swiss && \
	mv $*.deck.html $@

# deck.js PDF
../pub/%.deck.pdf : %.deck.html
	# Building PDF of deck.js slides
	deck2pdf  --profile=deckjs $< $@
	mv $*.deck.pdf $@

# remove targets
clean :
	rm ${TARGETS}

# remove targets, .compile.sh .do.txt files and files doconce can recreate
# use with care
cleanall :
	doconce clean
	rm ${DO_IN} ${COMMANDS} ${TARGETS}
